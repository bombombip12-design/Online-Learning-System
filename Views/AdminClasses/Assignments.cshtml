@model List<Assignment>
@using System.Linq
@using FinalASB.Models
@{
    Layout = "_AdminLayout";

    ViewBag.Title = "Class Management";

    var submissions = ViewBag.Submissions as List<Submission> ?? new List<Submission>();
}

<div class="page-header">
    <h2><i class="bi bi-file-earmark-text me-2"></i>Bài tập và điểm của lớp: @(ViewBag.Class?.ClassName ?? "Không xác định")</h2>
</div>

@if (Model.Any())

{
    @foreach (var assignment in Model)

    {

        var assignmentSubmissions = submissions.Where(s => s.AssignmentId == assignment.Id).ToList();

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text me-2"></i>@assignment.Title
                        <span class="badge bg-light text-dark ms-2">@assignmentSubmissions.Count bài nộp</span>
                    </h5>
                    <a href="/AdminClasses/ClassFullDetails/@assignment.Id" class="btn btn-sm btn-light text-primary">
                        <i class="bi bi-eye me-1"></i>Chi tiết
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <small class="text-muted"><i class="bi bi-person me-1"></i>Người tạo:</small>
                        <p class="mb-0"><span class="badge bg-info">@assignment.Creator.FullName</span></p>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted"><i class="bi bi-calendar me-1"></i>Ngày tạo:</small>
                        <p class="mb-0">@assignment.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    @if (assignment.DueDate.HasValue)

                    {
                        <div class="col-md-6 mt-2">
                            <small class="text-muted"><i class="bi bi-clock me-1"></i>Hạn nộp:</small>
                            @{
                                var isOverdue = assignment.DueDate.Value < DateTime.Now;
                            }
                            <p class="mb-0">
                                <span class="badge @(isOverdue ? "bg-danger" : "bg-warning")">
                                    <i class="bi bi-@(isOverdue ? "exclamation-triangle" : "clock") me-1"></i>
                                    @assignment.DueDate.Value.ToString("dd/MM/yyyy HH:mm")
                                </span>
                            </p>
                        </div>
                    }
                </div>

                @if (assignmentSubmissions.Any())

                {
                    <hr>
                    <h6 class="mb-3"><i class="bi bi-star me-2"></i>Danh sách bài nộp và điểm</h6>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">STT</th>
                                    <th><i class="bi bi-person me-2"></i>Học sinh</th>
                                    <th><i class="bi bi-envelope me-2"></i>Email</th>
                                    <th><i class="bi bi-calendar me-2"></i>Ngày nộp</th>
                                    <th class="text-center"><i class="bi bi-star me-2"></i>Điểm</th>
                                    <th><i class="bi bi-chat-left-text me-2"></i>Nhận xét</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int index = 1;
                                }
                                @foreach (var submission in assignmentSubmissions.OrderBy(s => s.Student.FullName))

                                {
                                    <tr>
                                        <td class="ps-4">@index</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-placeholder me-2" style="width: 32px; height: 32px; font-size: 0.75rem;">
                                                    @{
                                                        var studentInitials = !string.IsNullOrEmpty(submission.Student.FullName)

                                                        ? string.Join("", submission.Student.FullName.Split(' ').Take(2).Select(n => n[0].ToString().ToUpper()))

                                                        : "S";
                                                    }
                                                    @studentInitials
                                                </div>
                                                <span class="fw-semibold">@submission.Student.FullName</span>
                                            </div>
                                        </td>
                                        <td>@submission.Student.Email</td>
                                        <td>@submission.SubmittedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td class="text-center">
                                            @if (submission.Score.HasValue)
                                            {
                                                <span class="badge bg-success fs-6">@submission.Score</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Chưa chấm</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(submission.TeacherComment))
                                            {
                                                <span class="text-muted small">@submission.TeacherComment</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                    index++;

                                }
                            </tbody>
                        </table>
                    </div>
                }

                else

                {
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">Chưa có học sinh nào nộp bài</p>
                    </div>
                }
            </div>
        </div>
    }
}

else

{
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
            <p class="mt-3 mb-0 text-muted">Chưa có bài tập nào trong lớp này</p>
        </div>
    </div>
}

<div class="mt-4">
    <a href="/AdminClasses" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Quay lại danh sách lớp
    </a>
</div>

<style>
    .avatar-placeholder {
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        border: 2px solid #e2e8f0;
    }
</style>